{% extends 'index.html' %}

{% block title %}
    <div class="container" align="center">
      <div class="jumbotron">
        <h1>Welcome to Sudoku Solver</h1>
        <p>{{ description }}</p>
      </div>
    </div>
    <br>
{% endblock %}

{% block body %}
  <div class="container" align="center">
    <div class="alert alert-dark d-inline-block mt-3">
        <h4 class="mb-0">Time: <span id="timer">00:00</span></h4>
    </div>

{#    <div class="alert alert-info d-inline-block mt-3 ms-3">#}
{#        <h5 class="mb-0">Progress: <span id="progress">0/81</span></h5>#}
{#    </div>#}

    <div id="feedback-message" class="mt-3" style="min-height: 50px;"></div>

    <form method="POST" action="{% url 'solved' id=id %}" id="solution-form">
        {% csrf_token %}
        <input type="hidden" name="time_taken" id="time_taken_input" value="0">

        {% include 'grid.html' %}

        <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                Give Me Solution
            </button>
        </div>
    </form>
  </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let seconds = 0;
        let timerInterval;
        let checkTimeout;
        const validationUrl = "{% url 'validate_solution' id=id %}";
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Timer logic - START IMMEDIATELY
        function updateTimer() {
            seconds++;
            let mins = Math.floor(seconds / 60);
            let secs = seconds % 60;
            $('#timer').text(
                (mins < 10 ? '0' + mins : mins) + ':' +
                (secs < 10 ? '0' + secs : secs)
            );
            $('#time_taken_input').val(seconds);
        }

        // Start the timer immediately
        timerInterval = setInterval(updateTimer, 1000);

        // Update time before form submission
        $('#solution-form').on('submit', function() {
            $('#time_taken_input').val(seconds);
        });

        // Auto-validation
        $(document).ready(function() {
            const $cells = $('.cell');

            $cells.on('input', function() {
                this.value = this.value.replace(/[^1-9]/g, '');

                clearTimeout(checkTimeout);
                checkTimeout = setTimeout(validateSolution, 600);
            });

            // Initial progress update
            updateProgress();
        });

        function validateSolution() {
            const userInput = {};
            $('.cell').each(function() {
                if (this.name) {
                    userInput[this.name] = this.value || '';
                }
            });

            $.ajax({
                url: validationUrl,
                method: 'POST',
                contentType: 'application/json',
                headers: {'X-CSRFToken': csrfToken},
                data: JSON.stringify({user_input: userInput}),
                success: function(response) {
                    // Clear previous highlights
                    $('.cell').removeClass('is-invalid is-correct initial-cell');
                    $('td').removeClass('is-invalid is-correct');

                    // Mark initial cells
                    response.initial_cells.forEach(function(cellKey) {
                        $('[name="' + cellKey + '"]').addClass('initial-cell');
                    });

                    // Mark wrong cells
                    response.wrong_cells.forEach(function(cellKey) {
                        const $cell = $('[name="' + cellKey + '"]');
                        $cell.addClass('is-invalid');
                        $cell.closest('td').addClass('is-invalid');
                    });

                    // Mark correct cells
                    response.correct_cells.forEach(function(cellKey) {
                        const $cell = $('[name="' + cellKey + '"]');
                        $cell.addClass('is-correct');
                        $cell.closest('td').addClass('is-correct');
                    });

                    // Update progress
                    updateProgress(response.filled_count);

                    // Check if puzzle is complete and correct
                    if (response.is_complete) {
                        showMessage('ðŸŽ‰ Perfect! Redirecting to results...', 'success');

                        // Auto-submit the form after 2 seconds
                        setTimeout(function() {
                            $('#time_taken_input').val(seconds);
                            $('#solution-form').submit();
                        }, 2000);
                    }
                    // Show message for wrong cells
                    else if (response.message) {
                        const type = response.wrong_cells.length > 0 ? 'danger' : 'info';
                        showMessage(response.message, type);
                    } else {
                        clearMessage();
                    }
                },
                error: function(xhr) {
                    console.error('Validation error:', xhr.responseText);
                }
            });
        }

        function updateProgress(count) {
            if (count === undefined) {
                // Count manually if not provided
                count = $('.cell').filter(function() { return this.value; }).length;
            }
            $('#progress').text(count + '/81');
        }

        function showMessage(text, type) {
            $('#feedback-message').html(
                '<div class="alert alert-' + type + '" role="alert">' +
                text +
                '</div>'
            );
            setTimeout(clearMessage, 5000);
        }

        function clearMessage() {
            $('#feedback-message').html('');
        }
    </script>
{% endblock %}