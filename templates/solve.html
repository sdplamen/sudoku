{% extends 'index.html' %}

{% block title %}
    <div class="container" align="center">
      <div class="jumbotron">
        <h1>Welcome to Sudoku Solver</h1>
        <p>{{ description }}</p>
      </div>
    </div>
    <br>
{% endblock %}

{% block body %}
  <div class="container" align="center">
    <div class="alert alert-dark d-inline-block mt-3">
        <h4 class="mb-0">Time: <span id="timer">00:00</span></h4>
    </div>
    <div id="api-message-container" class="mt-3" style="min-height: 50px;"></div>
{#    <form method="POST" id="sudoku-form">#}
{#        <input type="hidden" name="time_taken" id="time_taken_input" value="0">#}
{#        {% csrf_token %}#}
{#        {% include 'insert.html' %}#}
{##}
{#        <div class="mt-3">#}
{#            <a href="{% url 'solved' id=id %}" class="btn btn-primary btn-lg">Solve Board</a>#}
{#        </div>#}
{#    </form>#}
    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="time_taken" id="time_taken_input" value="0">

        {% include 'insert.html' %}

        <div class="mt-4">
            <button type="button" onclick="checkProgress('{{ id }}')" class="btn btn-warning">
                Check My Work (API)
            </button>

            <a href="{% url 'solved' id=id %}" class="btn btn-primary">
                Give Me Solution
            </a>
        </div>
    </form>
  </div>

    <script>
        let seconds = 0;
        let timerDisplay = document.getElementById('timer');

        function updateTimer() {
            seconds++;
            let mins = Math.floor(seconds / 60);
            let secs = seconds % 60;
            let displayMins = mins < 10 ? '0' + mins : mins;
            let displaySecs = secs < 10 ? '0' + secs : secs;

            timerDisplay.innerText = displayMins + ":" + displaySecs;
        }
        setInterval(updateTimer, 1000);

        async function checkProgress(puzzleId) {
            const messageContainer = document.getElementById('api-message-container');
            const inputs = document.querySelectorAll('.cell');
            let userData = {};

            inputs.forEach(input => {
                if (input.value) { userData[input.name] = input.value; }
            });

            try {
                const response = await fetch(`/api/puzzles/${puzzleId}/solve/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ grid_input: userData, reveal: false })
                });

                const result = await response.json();

                messageContainer.innerHTML = '';
                document.querySelectorAll('td').forEach(td => td.classList.remove('is-invalid'));

                if (result.wrong_cells.length > 0) {
                    result.wrong_cells.forEach(cellKey => {
                        const inputElement = document.querySelector(`[name="${cellKey}"]`);
                        if (inputElement) {
                            inputElement.closest('td').classList.add('is-invalid');
                        }
                    });
                    showMessage("Some numbers are incorrect. Keep trying!", "danger");
                }
                else if (result.is_correct) {
                    showMessage("Amazing! You solved the puzzle correctly!", "success");
                }
                else {
                    showMessage("Everything looks good so far! Keep going.", "info");
                }

            } catch (error) {
                showMessage("Connection error. Is the server running?", "warning");
            }
        }

        function showMessage(text, type) {
            const container = document.getElementById('api-message-container');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    }
    </script>
{% endblock %}